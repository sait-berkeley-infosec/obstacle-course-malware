/* Driver Killer
 * Written for the 2014 Obstacle Course
 * nwold - InfoSec Lead 2014
 */

#include <windows.h>

BOOL debug = FALSE;

LRESULT CALLBACK WindowProc(HWND hwnd, UINT message, WPARAM wp, LPARAM lp);

int WINAPI wWinMain(HINSTANCE hInstance, HINSTANCE, PWSTR pCmdLine, int nCmdShow) {
  /* The main method.
   * Analogous to a main() function
   */
  if (debug) {
    createDebugWindow();
  }

  while (GetMessage (&msgs, NULL, 0, 0)) {
    TranslateMessage(&msgs);
    DispatchMessage(&msgs);
  }

  return 0;
}

LRESULT CALLBACK WindowProc(HWND hwnd, UINT message, WPARAM wp, LPARAM lp) {
  /* Called by DispatchMessage
   * Detects if mouse was moved.
   */
  switch (message) {
    case WM_MOUSEMOVE:
      if (debug) {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        FillRect(hdc, &ps.rcPaint, (HBRUSH) (COLOR_3DSHADOW+1));
        EndPaint(hwnd, &ps);
      } else {
        //payload();
      }
      break;
    default:
      if (debug) {
        PAINTSTRUCT ps;
        HDC hdc = BeginPaint(hwnd, &ps);
        FillRect(hdc, &ps.rcPaint, (HBRUSH) (COLOR_WINDOW+1));
        EndPaint(hwnd, &ps);
      }
  }
  return DefWindowProc(hwnd, uMsg, wParam, lParam);
}

void payload() {
  /* Called when mouse is moved.
   * Delivers the payload.
   */
}

void createDebugWindow() {
  /* This is a thing copy-pasted from Microsoft.
   * I use this to debug if the mouse is actually detected.
   */

  // Register the window class.
  const wchar_t CLASS_NAME[]  = L"Sample Window Class";
  
  WNDCLASS wc = { };

  wc.lpfnWndProc   = WindowProc;
  wc.hInstance     = hInstance;
  wc.lpszClassName = CLASS_NAME;

  RegisterClass(&wc);

  // Create the window.

  HWND hwnd = CreateWindowEx(
      0,                              // Optional window styles.
      CLASS_NAME,                     // Window class
      L"Learn to Program Windows",    // Window text
      WS_OVERLAPPEDWINDOW,            // Window style

      // Size and position
      CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT, CW_USEDEFAULT,

      NULL,       // Parent window    
      NULL,       // Menu
      hInstance,  // Instance handle
      NULL        // Additional application data
      );

  if (hwnd == NULL)
  {
      return 0;
  }

  ShowWindow(hwnd, nCmdShow);
}
